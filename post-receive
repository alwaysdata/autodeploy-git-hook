#!/bin/bash
###
# CONFIG VARS
###
TARGET="/home/madslab/net.madslab/test"      # the directory where the files need to be deployed
GIT_DIR="/home/madslab/data/test-deploy.git" # the current git bare repository path
BRANCH="production"                          # the branch to deploy (default to `production`)
# In case you want to restart your app after deploy, you need to fill:
RESTART=false           # a boolean to enable restart (default to `false`)
API_KEY=""              # your api key you can find in your *profile* section
ACCOUNT=""              # the account name your site is associated to
PASSWORD=""             # the account password your site is associated to
SITE_ID="000000"        # the reference ID of your site you can find in your *sites* section

###
# DO NOT EDIT BELOW UNLESS YOU KNOW WHAT YOU'RE DOING
###
while read oldrev newrev ref; do
	# only checking out the branch to deploy
	if [[ $ref = refs/heads/$BRANCH ]]; then
		echo "Ref '$ref' received."

		if [ ! -d "$TARGET" ]; then
			echo "'${TARGET}' dir is missing, creating it"
			mkdir -p $TARGET
		fi

		echo "Deploying '${BRANCH}' branch to production"
		git --work-tree=$TARGET --git-dir=$GIT_DIR checkout --force $BRANCH

		if [ "$RESTART" = true ]; then
			echo "Restarting your web server ..."

			encoded_token=$(echo "$API_KEY account=$ACCOUNT:$PASSWORD" | base64 -w 0)
			status=$(curl --location --request POST "https://api.alwaysdata.com/v1/site/${SITE_ID}/restart/" --header "Authorization: Basic $encoded_token" --write-out '%{http_code}' --silent)

			if [ "$status" = 204 ]; then
				echo "‚úÖ Site successfully restarted!"
			else
				echo "‚ùå An error occured when restarting your site, try to restart it manually"
				exit 1
			fi
		fi

		exit 0
	else
		echo "üôÑ You pushed '$ref' branch,"
		echo "but you set '${BRANCH}' branch as deploy branch."
		echo "Exiting without error."

		exit 0
	fi
done
